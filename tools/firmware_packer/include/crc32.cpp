//------------------------------------------------------------------------------------------------------------
//
//2008-10-2 17:48
//
//scott
//
//crc32.cpp
//
//------------------------------------------------------------------------------------------------------------


#include <stdio.h>
#include <memory.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>


#include "..\..\include\crc32.h"


//------------------------------------------------------------------------------------------------------------
//计算crc32
//------------------------------------------------------------------------------------------------------------
u32 cal_crc32(void * buffer, u32 bufferlen)		
{
	typedef struct tag_CRC32_DATA
	{
		u32 CRC;				//在Windows下编程，int的大小是32位
		u32 CRC_32_Tbl[256];	//用来保存码表
	}CRC32_DATA_t;

	u32 i, j;
	
	CRC32_DATA_t CRC32Data;
	CRC32Data.CRC = 0;
	
	for( i = 0; i < 256; ++i)//用++i以提高效率
	{
		CRC32Data.CRC = i;
		for( j = 0; j < 8 ; ++j)
		{
			//----------------------------------------------------------
			//这个循环实际上就是用"计算法"来求取CRC的校验码
			//----------------------------------------------------------
			if(CRC32Data.CRC & 1)
				CRC32Data.CRC = (CRC32Data.CRC >> 1) ^ 0xEDB88320;
			else //0xEDB88320就是CRC-32多项表达式的值
				CRC32Data.CRC >>= 1;
		}
		CRC32Data.CRC_32_Tbl[i] = CRC32Data.CRC;
	}
	
	u32 CRC32 = 0xffffffff; //设置初始值
    for(i = 0; i < bufferlen; ++i)
    {
        CRC32 = CRC32Data.CRC_32_Tbl[(CRC32^((unsigned char*)buffer)[i]) & 0xff] ^ (CRC32>>8); 
    }
	return CRC32^0xffffffff;
}


//------------------------------------------------------------------------------------------------------------
//                                          TEST PROGRAM
//------------------------------------------------------------------------------------------------------------



//------------------------------------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------------------------------------
u32 crc_test()
{	
	char crcbuffer[] =  "1234567890";
	u32 crc32 = cal_crc32(crcbuffer, 10);
	if (0x261daee5 != crc32)
		return __LINE__;
		
	printf("CRC test OK \n");
	return OK;
}
